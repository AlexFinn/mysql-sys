-- source include/not_embedded.inc
-- source ../include/ps_truncate_all_tables.inc
# Tests for sys schema
# Verify the sys.innodb_buffer_stats_by_table view

# Ensure structure changes don't slip in
DESC sys.innodb_buffer_stats_by_table;

# Make sure view select does not error, but ignore results
--disable_result_log
SELECT * FROM sys.innodb_buffer_stats_by_table;
--enable_result_log


# Ensure structure changes don't slip in
DESC sys.x$innodb_buffer_stats_by_table;

# Make sure view select does not error, but ignore results
--disable_result_log
SELECT * FROM sys.x$innodb_buffer_stats_by_table;
--enable_result_log


# Check that the old pages percentage is smaller than @@global.innodb_old_blocks_pct
# Add 3 percent to avoid false positives due to rounding errors
SELECT (SUM(pages_old)/sum(pages)*100 < (@@global.innodb_old_blocks_pct + 3)) AS OldPagesSmallEnough
  FROM sys.innodb_buffer_stats_by_table;

SELECT (SUM(pages_old)/sum(pages)*100 < (@@global.innodb_old_blocks_pct + 3)) AS OldPagesSmallEnough
  FROM sys.x$innodb_buffer_stats_by_table;
